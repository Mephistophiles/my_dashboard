#!/usr/bin/env bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –¥–∞—à–±–æ—Ä–¥–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∞
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./run.sh [–≥–æ—Ä–æ–¥] [—à–∏—Ä–æ—Ç–∞] [–¥–æ–ª–≥–æ—Ç–∞] [api_key]

echo "üì∏ –ó–∞–ø—É—Å–∫ –¥–∞—à–±–æ—Ä–¥–∞ –¥–ª—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–æ–≤"
echo "=================================="

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
CITY=${1:-"–ú–æ—Å–∫–≤–∞"}
LATITUDE=${2:-"55.7558"}
LONGITUDE=${3:-"37.6176"}
OPENWEATHER_API_KEY=${4:-"demo_key"}

echo "üìç –õ–æ–∫–∞—Ü–∏—è: $CITY ($LATITUDE, $LONGITUDE)"
echo "üîë API –∫–ª—é—á: ${OPENWEATHER_API_KEY:0:8}..." # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 8 —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

# –ü—Ä–æ–≤–µ—Ä—è–µ–º DEMO —Ä–µ–∂–∏–º
if [ "$OPENWEATHER_API_KEY" = "demo_key" ] || [ "$DEMO_MODE" = "true" ]; then
    echo "üé≠ DEMO —Ä–µ–∂–∏–º: –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ"
    export DEMO_MODE=true
else
    echo "üåê Production —Ä–µ–∂–∏–º: –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ API"
    export DEMO_MODE=false
fi

echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ API –∫–ª—é—á –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ -z "$4" ] && [ -n "$OPENWEATHER_API_KEY" ]; then
    echo "‚ÑπÔ∏è  –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è API –∫–ª—é—á –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è OPENWEATHER_API_KEY"
fi

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
export CITY="$CITY"
export LATITUDE="$LATITUDE"
export LONGITUDE="$LONGITUDE"
export OPENWEATHER_API_KEY="$OPENWEATHER_API_KEY"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ Cargo —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
if ! command -v cargo &> /dev/null; then
    echo "‚ùå –û—à–∏–±–∫–∞: Cargo –Ω–µ –Ω–∞–π–¥–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Rust —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–æ–µ–∫—Ç —Å–æ–±—Ä–∞–Ω
if [ ! -d "target" ]; then
    echo "üî® –ü–µ—Ä–≤–∞—è —Å–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
    cargo build --release
fi

echo "üöÄ –ó–∞–ø—É—Å–∫ –¥–∞—à–±–æ—Ä–¥–∞..."
echo ""

# –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
cargo run

echo ""
echo "‚úÖ –î–∞—à–±–æ—Ä–¥ –∑–∞–≤–µ—Ä—à–µ–Ω" 
